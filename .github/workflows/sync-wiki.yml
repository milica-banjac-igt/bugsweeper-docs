name: Sync Wiki to GitHub Pages

on:
  schedule:
    # Run at 1:00 AM UTC every day (adjust as needed)
    - cron: '0 1 * * *'
  # Allow manual triggering from the GitHub Actions tab
  workflow_dispatch:

jobs:
  sync-wiki-to-pages:
    runs-on: ubuntu-latest  # Changed to Ubuntu for better tool support
    steps:
      - name: Check out bugsweeper-docs repository
        uses: actions/checkout@v3
        with:
          repository: milica-banjac-igt/bugsweeper-docs
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          path: bugsweeper-docs

      - name: Set up Git identity
        run: |
          git config --global user.email "wiki-sync@example.com"
          git config --global user.name "Wiki Sync Action"

      # Using git clone with token embedded instead of actions/checkout for the wiki
      - name: Clone wiki repository with embedded token
        run: |
          git clone https://x-access-token:${{ secrets.PERSONAL_ACCESS_TOKEN }}@github.com/igt-all/BugSweeper-Workshops.wiki.git wiki-repo
        shell: bash

      - name: Check repository structure and copy images if available
        run: |
          mkdir -p output-files
          # List the wiki-repo contents to debug
          echo "Contents of wiki-repo:"
          ls -la wiki-repo/
          
          # Check if Images directory exists, create if not
          if [ -d "wiki-repo/Images" ]; then
            echo "Images directory found, copying to output-files"
            cp -r wiki-repo/Images output-files/
          elif [ -d "wiki-repo/images" ]; then
            echo "images directory found (lowercase), copying to output-files"
            cp -r wiki-repo/images output-files/
            # Rename to ensure consistency with the rest of the script
            mv output-files/images output-files/Images
          else
            echo "No Images directory found, creating empty one"
            mkdir -p output-files/Images
            mkdir -p wiki-repo/Images
          fi
        shell: bash

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc wkhtmltopdf
        shell: bash

      - name: Process images
        run: |
          cd wiki-repo
          # Create a script for image processing
          cat > process-images.sh << 'EOL'
          #!/bin/bash
          
          # Check if we have any markdown files
          if [ ! "$(ls -A *.md 2>/dev/null)" ]; then
            echo "No markdown files found!"
            exit 0
          fi
          
          # Check if Images directory exists
          if [ ! -d "./Images" ]; then
            echo "Images directory not found, creating it"
            mkdir -p ./Images
          fi
          
          for mdfile in *.md; do
            echo "Processing file: $mdfile"
            content=$(cat "$mdfile")
            
            # Find unique GitHub asset URLs and replace them
            if grep -q 'https://github.com/user-attachments/assets/' "$mdfile"; then
              grep -o 'https://github.com/user-attachments/assets/[a-zA-Z0-9-]*' "$mdfile" | sort | uniq | while read url; do
                hash=$(echo "$url" | sed 's|.*/||')
                image=$(find ./Images -type f -name "*$hash*" -o -name "$hash.*" 2>/dev/null | head -1)
                
                if [ -n "$image" ]; then
                  localpath="./Images/$(basename "$image")"
                  echo "Replacing $url with $localpath"
                  sed -i "s|$url|$localpath|g" "$mdfile"
                else
                  echo "No local image found for hash: $hash"
                fi
              done
            else
              echo "No GitHub asset URLs found in $mdfile"
            fi
            
            echo "Updated file: $mdfile"
          done
          echo "Process completed!"
          EOL
          
          chmod +x process-images.sh
          ./process-images.sh
        shell: bash

      - name: Generate PDFs
        run: |
          cd wiki-repo
          mkdir -p ../output-files/pdfs
          
          # Check if we have markdown files
          if [ ! "$(ls -A *.md 2>/dev/null)" ]; then
            echo "No markdown files found in wiki-repo!"
            # Create a basic README.pdf so we have at least one PDF
            echo "# BugSweeper Workshops" > README.md
            echo "Documentation is being prepared. Please check back later." >> README.md
            pdffile="../output-files/pdfs/README.pdf"
            pandoc README.md -o "$pdffile" --pdf-engine=wkhtmltopdf
            exit 0
          fi
          
          # Get all MD files but exclude readme files for the sync scripts
          for mdfile in $(ls -1 *.md 2>/dev/null | grep -v "wiki-sync-readme" || echo ""); do
            if [ -f "$mdfile" ]; then
              pdffile="../output-files/pdfs/$(basename "${mdfile%.md}.pdf")"
              echo "Converting $mdfile to PDF..."
              
              # Create a simple HTML version first
              echo "<html><body>" > temp.html
              cat "$mdfile" | sed -e 's|!\[\(.*\)\](./Images/\(.*\))|<img src="./Images/\2" alt="\1" style="max-width:100%;">|g' >> temp.html
              echo "</body></html>" >> temp.html
              
              # Try multiple PDF generation methods
              if command -v wkhtmltopdf >/dev/null 2>&1; then
                echo "Using wkhtmltopdf directly..."
                wkhtmltopdf temp.html "$pdffile" || true
              fi
              
              if [ ! -f "$pdffile" ] || [ ! -s "$pdffile" ]; then
                echo "Trying pandoc with wkhtmltopdf..."
                pandoc "$mdfile" -o "$pdffile" --pdf-engine=wkhtmltopdf || true
              fi
              
              if [ ! -f "$pdffile" ] || [ ! -s "$pdffile" ]; then
                echo "Creating fallback PDF with basic content..."
                echo "<html><body><h1>$(basename "${mdfile%.md}")</h1><p>Please view the original markdown file for content.</p></body></html>" > temp_fallback.html
                wkhtmltopdf temp_fallback.html "$pdffile" || true
                rm -f temp_fallback.html
              fi
              
              # Clean up
              rm -f temp.html
              
              # Verify PDF was created
              if [ -f "$pdffile" ] && [ -s "$pdffile" ]; then
                echo "PDF generation for $mdfile complete: $(ls -la "$pdffile")"
              else
                echo "WARNING: Failed to create PDF for $mdfile"
                # Create an empty file so we at least have something
                touch "$pdffile"
              fi
            fi
          done
          
          # List generated PDFs
          echo "Generated PDFs:"
          ls -la ../output-files/pdfs/
        shell: bash

      - name: Copy PDFs to bugsweeper-docs repository
        run: |
          # Create workshop-pdfs directory if it doesn't exist
          mkdir -p bugsweeper-docs/workshop-pdfs
          
          # Check if output-files/pdfs directory exists and has files
          if [ -d "output-files/pdfs" ] && [ "$(find output-files/pdfs -name "*.pdf" -type f 2>/dev/null)" ]; then
            echo "Copying PDF files to GitHub Pages directory"
            cp -f output-files/pdfs/*.pdf bugsweeper-docs/workshop-pdfs/ || true
          else
            echo "No PDFs found in output directory. Creating a placeholder PDF."
            mkdir -p output-files/pdfs
            echo "<html><body><h1>BugSweeper Workshops</h1><p>Documentation is being prepared. Please check back later.</p></body></html>" > temp.html
            wkhtmltopdf temp.html output-files/pdfs/README.pdf || true
            cp -f output-files/pdfs/README.pdf bugsweeper-docs/workshop-pdfs/ || true
            rm -f temp.html
          fi
          
          # List files to debug
          echo "Files in output-files/pdfs:"
          find output-files/pdfs -type f -ls || echo "No files found"
          echo "Files in bugsweeper-docs/workshop-pdfs:"
          find bugsweeper-docs/workshop-pdfs -type f -ls || echo "No files found"
        shell: bash

      - name: Create index.html
        run: |
          cd bugsweeper-docs
          
          # Generate index.html
          cat > index.html << EOL
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>BugSweeper Workshops Documentation</title>
              <style>
                  body {
                      font-family: Arial, sans-serif;
                      line-height: 1.6;
                      max-width: 800px;
                      margin: 0 auto;
                      padding: 20px;
                  }
                  h1 {
                      color: #333;
                      text-align: center;
                  }
                  .pdf-list {
                      list-style: none;
                      padding: 0;
                  }
                  .pdf-list li {
                      margin: 10px 0;
                      padding: 10px;
                      background-color: #f5f5f5;
                      border-radius: 5px;
                  }
                  .pdf-list a {
                      color: #0066cc;
                      text-decoration: none;
                      font-weight: bold;
                  }
                  .pdf-list a:hover {
                      text-decoration: underline;
                  }
                  .timestamp {
                      color: #666;
                      font-size: 0.8em;
                      text-align: center;
                      margin-top: 40px;
                  }
              </style>
          </head>
          <body>
              <h1>BugSweeper Workshops Documentation</h1>
              <p>This page provides access to the latest PDF documentation for the BugSweeper Workshops.</p>
              
              <ul class="pdf-list">
          EOL
          
          # Add links to each PDF file
          for pdf in workshop-pdfs/*.pdf; do
            if [ -f "$pdf" ]; then
              filename=$(basename "$pdf")
              name=$(echo "${filename%.pdf}" | sed 's/-‐-/ - /g')
              echo "    <li><a href=\"$pdf\" target=\"_blank\">$name</a></li>" >> index.html
            fi
          done
          
          # Close the HTML content
          cat >> index.html << EOL
              </ul>
              
              <p class="timestamp">Last updated: $(date '+%B %d, %Y %H:%M')</p>
          </body>
          </html>
          EOL
          
          echo "Created index.html file"
        shell: bash

      - name: Commit and push changes to GitHub Pages
        run: |
          cd bugsweeper-docs
          git add --all
          git commit -m "Updated workshop PDFs - $(date '+%Y-%m-%d %H:%M')"
          git push origin main
        shell: bash
